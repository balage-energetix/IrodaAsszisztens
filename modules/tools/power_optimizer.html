<!DOCTYPE html>
<html lang="hu" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teljesítmény Optimalizáló - Irodai Asszisztens</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@800&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'><path fill='%239fb0ff' d='M420.55,301.93a24,24,0,1,1,24-24,24,24,0,0,1-24,24m-265.1,0a24,24,0,1,1,24-24,24,24,0,0,1-24,24m273.7,70.59a12,12,0,0,1,0,24H147.15a12,12,0,0,1,0-24ZM532,224H480V128a128,128,0,0,0-256,0v96H172a52,52,0,0,0-52,52V460a52,52,0,0,0,52,52H404a52,52,0,0,0,52-52V276a52,52,0,0,0-52-52ZM272,128a80,80,0,0,1,160,0v32H272Zm132,332H172a20,20,0,0,1-20-20V276a20,20,0,0,1,20-20H404a20,20,0,0,1,20,20V440a20,20,0,0,1-20,20M96,192V112a16,16,0,0,0-32,0v80a16,16,0,0,0,32,0m448,0V112a16,16,0,0,0-32,0v80a16,16,0,0,0,32,0'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            background: var(--bg-creamy);
        }

        :root {
            --bg-pro: #f8fafc;
            --accent-pro: #4361ee;
            --danger-pro: #ef4444;
            --success-pro: #10b981;
            --warning-pro: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-pro: #1e293b;
        }

        .opt-container {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .data-input-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .month-input {
            background: var(--bg-creamy) !important;
            border: 1.5px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 700;
            color: var(--text-main) !important;
            width: 100%;
            transition: all 0.2s;
        }

        .month-input.invalid {
            border-color: var(--danger-pro) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .styled-input,
        .styled-select {
            background: var(--bg-creamy) !important;
            color: var(--text-main) !important;
            border: 1.5px solid var(--border-color) !important;
            padding: 0.75rem;
            border-radius: 0.6rem;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }

        .field-label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.4rem;
            color: var(--text-main);
            font-size: 0.85rem;
        }

        .pro-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            height: 100%;
        }

        .btn-calc {
            background: var(--success-pro);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 800;
            width: 100%;
            cursor: pointer;
            font-family: 'Outfit';
            font-size: 1.1rem;
            margin-top: 1rem;
            transition: transform 0.2s;
        }

        .btn-calc:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        #error-banner {
            display: none;
            background: var(--danger-pro);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 700;
            text-align: center;
        }

        .result-summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .summary-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.85rem;
            border-radius: 0.75rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #no-data-banner {
            display: none;
            background: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            border: 1px solid #fecaca;
            font-weight: 700;
            text-align: center;
        }

        .savings-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            margin-top: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
            display: none;
        }

        .savings-box .save-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 800;
            opacity: 0.9;
        }

        .savings-box .save-value {
            font-size: 1.75rem;
            font-weight: 900;
            margin: 0.25rem 0;
        }

        .savings-box .save-percent {
            font-size: 0.85rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
        }

        .summary-box span {
            display: block;
            font-size: 0.6rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            line-height: 1.1;
        }

        .summary-box strong {
            font-size: 1.1rem;
            color: var(--accent-pro);
            white-space: nowrap;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .cost-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .cost-row .label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .cost-row .value {
            font-weight: 700;
            color: var(--text-main);
        }

        .announced-highlight {
            border: 2px solid var(--success-pro) !important;
            background: rgba(16, 185, 129, 0.05) !important;
        }

        .max-highlight {
            border: 2px solid var(--warning-pro) !important;
            background: rgba(245, 158, 11, 0.05) !important;
        }

        .info-bar {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 2rem;
            font-size: 0.85rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-item i {
            color: var(--accent-pro);
        }

        .info-item strong {
            color: var(--text-main);
        }

        .info-item .percentage {
            background: var(--accent-pro);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 800;
        }

        /* PRINTING MODE STYLES */
        body.printing-mode {
            background-color: white !important;
            color: black !important;
            height: auto !important;
            overflow: visible !important;
        }

        body.printing-mode * {
            color: black !important;
            border-color: black !important;
            text-shadow: none !important;
            opacity: 1 !important;
            /* Fix grayness from opacity */
            box-shadow: none !important;
            transition: none !important;
            /* Prevent animations during capture */
        }

        /* Essential overrides for full visibility */
        body.printing-mode .pro-card,
        body.printing-mode .opt-container,
        body.printing-mode .info-bar,
        body.printing-mode input,
        body.printing-mode select,
        body.printing-mode textarea {
            background-color: white !important;
            background: white !important;
            border: 1px solid #000 !important;
            box-shadow: none !important;
            max-height: none !important;
            /* CRITICAL FIX for cropping */
            overflow: visible !important;
            /* CRITICAL FIX for scrolling */
            height: auto !important;
        }

        /* Ensure input area expands fully */
        body.printing-mode .data-input-area {
            display: block !important;
            /* Stack columns for better vertical fit if needed, or keep grid */
            margin-bottom: 20px !important;
        }

        body.printing-mode .month-grid {
            /* Ensure grid cells are visible */
            page-break-inside: avoid;
        }

        body.printing-mode .savings-box {
            background: white !important;
            color: black !important;
            border: 2px solid #000 !important;
            display: block !important;
            /* Ensure visibility if relevant */
        }

        /* Hide UI elements */
        body.printing-mode button,
        body.printing-mode .app-header,
        body.printing-mode #calc-hint,
        body.printing-mode .no-print,
        body.printing-mode #bulk-input,
        /* Hide bulk text area, just show inputs */
        body.printing-mode .mt-4.small.text-muted {
            /* Hide help text */
            display: none !important;
        }

        body.printing-mode .module-header {
            margin-bottom: 20px !important;
        }

        body.printing-mode canvas {
            background-color: white !important;
        }

        /* Ensure container fits A4 width approx */
        body.printing-mode .container {
            max-width: 100% !important;
            width: 100% !important;
            padding: 20px !important;
            /* More padding */
            margin: 0 !important;
        }

        /* STACK EVERYTHING VERTICALLY FOR SAFETY */
        body.printing-mode .row {
            display: block !important;
            margin: 0 !important;
        }

        body.printing-mode .col-md-5,
        body.printing-mode .col-md-7,
        body.printing-mode .col-12 {
            width: 100% !important;
            max-width: 100% !important;
            flex: none !important;
            padding: 0 !important;
            margin-bottom: 20px !important;
        }

        /* Fix overlapping inputs area */
        body.printing-mode .data-input-area {
            display: block !important;
        }

        body.printing-mode .data-input-area>div {
            margin-bottom: 20px !important;
        }

        /* Fix Result Summary Grid - Allow wrapping */
        body.printing-mode .result-summary-grid {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 10px !important;
            justify-content: space-between !important;
        }

        body.printing-mode .summary-box {
            flex: 1 1 18% !important;
            /* Approx 5 items per row if fit, or wrap */
            min-width: 100px !important;
        }

        /* HEADER SPACING FIX - Force non-overlapping stack but COMPACT */
        body.printing-mode .module-header {
            margin-bottom: 25px !important;
            display: block !important;
            height: auto !important;
            position: relative !important;
            padding-bottom: 5px !important;
        }

        body.printing-mode .module-header h2 {
            margin-bottom: 15px !important;
            /* Increased from 5px to prevent overlap */
            padding-bottom: 5px !important;
            line-height: 1.3 !important;
            font-size: 22px !important;
            /* Smaller font */
            display: block !important;
            color: #000 !important;
            border-bottom: 1px solid #eee !important;
        }

        body.printing-mode .module-header p {
            margin-top: 0 !important;
            /* Compacted */
            margin-bottom: 15px !important;
            display: block !important;
            color: #444 !important;
            font-size: 12px !important;
            /* Smaller font */
            line-height: 1.3 !important;
        }

        /* COMPACT INPUT GRID FOR SINGLE PAGE FIT */
        body.printing-mode .month-grid {
            grid-template-columns: repeat(6, 1fr) !important;
            /* More columns = less rows */
            gap: 4px !important;
        }

        body.printing-mode .month-input {
            padding: 2px !important;
            font-size: 10px !important;
            height: auto !important;
        }

        body.printing-mode .field-label {
            font-size: 8px !important;
            margin-bottom: 0 !important;
        }

        body.printing-mode #m-cont-0,
        body.printing-mode #m-cont-1,
        body.printing-mode .p-1 {
            padding: 1px !important;
        }

        /* INPUT / SELECT / TEXTAREA COLOR FIX */
        /* Specificity override to ensure browser forms don't override color */
        body.printing-mode select,
        body.printing-mode input,
        body.printing-mode textarea,
        body.printing-mode .styled-input,
        body.printing-mode .styled-select {
            color: #000000 !important;
            -webkit-text-fill-color: #000000 !important;
            /* Some webkits need this */
            border: 1px solid #000 !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
            opacity: 1 !important;
            font-weight: 700 !important;
            font-size: 11px !important;
            /* Smaller font */
            padding: 4px !important;
            /* Compact padding */
            min-height: 0 !important;
            height: auto !important;
        }

        /* Reduce general card padding in print */
        body.printing-mode .pro-card {
            padding: 10px !important;
            margin-bottom: 10px !important;
            border: 1px solid #ccc !important;
        }

        body.printing-mode h5 {
            font-size: 14px !important;
            margin-bottom: 8px !important;
        }

        body.printing-mode .data-input-area {
            margin-bottom: 10px !important;
            gap: 10px !important;
        }

        body.printing-mode .data-input-area>div {
            margin-bottom: 10px !important;
        }

        /* Ensure dropdown arrows or icons don't create white space issues */
        body.printing-mode select {
            -webkit-appearance: none !important;
            appearance: none !important;
            background-image: none !important;
            /* Remove custom arrows if any */
        }

        /* CHART RESIZE - Make it smaller to fit */
        body.printing-mode .pro-card {
            height: auto !important;
            /* Allow expansion */
        }

        body.printing-mode canvas {
            max-width: 90% !important;
            max-height: 250px !important;
            /* Force shorter chart */
            width: auto !important;
            height: auto !important;
            margin: 0 auto !important;
            display: block !important;
        }

        /* Hide spacer elements if any */
        body.printing-mode .mb-3,
        body.printing-mode .mb-4 {
            margin-bottom: 5px !important;
        }

        /* Info Bar wrapping */
        body.printing-mode .info-bar {
            flex-wrap: wrap !important;
            gap: 10px !important;
            padding: 5px !important;
            margin-bottom: 10px !important;
            height: auto !important;
        }

        /* PRINT SPECIFIC HEADER (Logo + Date) */
        .print-header-only {
            display: none;
        }

        body.printing-mode .print-header-only {
            display: flex !important;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        body.printing-mode .print-header-only .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        body.printing-mode .print-header-only i {
            font-size: 2rem;
            color: #000;
        }

        body.printing-mode .print-header-only .print-date {
            font-size: 0.9rem;
            font-weight: 700;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <header class="app-header">
        <a href="../../index.html" class="logo">
            <i class="fab fa-android"></i>
            <span>IRODAI<br>ASSZISZTENS</span>
        </a>
        <div class="header-info">
            <!-- Data injected by main.js -->
        </div>
    </header>

    <main class="container py-5 fade-in">
        <!-- Print Only Header -->
        <div class="print-header-only">
            <div class="logo-section">
                <i class="fab fa-android"></i>
                <div style="line-height:1.2; font-weight:800;">IRODAI<br>ASSZISZTENS</div>
            </div>
            <div class="print-date" id="print-date-display"></div>
        </div>

        <div class="module-header mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 style="font-weight: 800;">Lekötött Teljesítmény Optimalizáló</h2>
                <p class="text-muted small">Precíziós kalkulátor bejelentési kockázatelemzéssel (MEKH 2025).</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary"
                    style="border-radius:1rem; padding: 0.75rem 1.5rem; background: var(--accent-pro);"
                    onclick="exportPowerReport()">
                    <i class="fas fa-print me-2"></i> PDF NYOMTATÁS
                </button>
                <button class="btn btn-warning" style="border-radius:1rem; padding: 0.75rem 1.5rem; font-weight:800;"
                    onclick="window.open('https://www.eon.hu/hu/egyeb/forms/leopold.html', '_blank')">
                    <i class="fas fa-bolt me-2"></i> E.ON VÁLTOZÁSBEJELENTŐ
                </button>
            </div>
        </div>

        <div id="error-banner"><i class="fas fa-warning me-2"></i> Saját téves érték! Kérjük ellenőrizze az adatokat
            (Max 100 kW, csak számok).</div>
        <div id="no-data-banner" style="background: #fff3cd; color: #856404; border-color: #ffeeba;"><i
                class="fas fa-info-circle me-2"></i> Adjon meg legalább 5 hónap csúcsteljesítmény adatot a pontos
            optimalizáláshoz!</div>

        <div class="info-bar" id="penalty-info-bar">
            <div class="info-item">
                <i class="fas fa-bullhorn"></i>
                <div>
                    <span>Bejelentett pótdíj:</span>
                    <strong id="ann-factor-display">10%</strong>
                    <span class="percentage">Ft/kW/hó: <span id="ann-money-display">--</span></span>
                </div>
            </div>
            <div class="info-item">
                <i class="fas fa-bolt-lightning"></i>
                <div>
                    <span>Be nem jelentett pótdíj:</span>
                    <strong id="unann-factor-display">25%</strong>
                    <span class="percentage" style="background: var(--warning-pro);">Ft/kW/hó: <span
                            id="unann-money-display">--</span></span>
                </div>
            </div>
        </div>

        <div class="opt-container">
            <div class="data-input-area">
                <div class="pro-card">
                    <h5 class="mb-3" style="font-weight: 800;">Beállítások</h5>

                    <div class="mb-3">
                        <label class="field-label">Tarifa (E.ON / MEKH 2025)</label>
                        <select id="tariff-select" class="styled-select" onchange="updateTariffValue()">
                            <option value="13248">KIF III - 13 248 Ft/kW/év</option>
                            <option value="16608">KÖF - 16 608 Ft/kW/év</option>
                            <option value="custom">Egyedi számítás...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="field-label">Jelenlegi lekötött teljesítmény (kW)</label>
                        <input type="number" id="current-contract-cap" value="45" class="styled-input"
                            placeholder="Példa: 45">
                    </div>

                    <div id="custom-fee-block" class="mb-3" style="display:none;">
                        <label class="field-label">Egyedi Éves Díj (Ft/kW/év)</label>
                        <input type="number" id="annual-fee" value="13248" class="styled-input"
                            oninput="updatePenaltyInfo()">
                    </div>

                    <div class="mb-3">
                        <label class="field-label">Add meg az elmúlt időszakok havi csúcsteljesítményeit.</label>
                        <textarea id="bulk-input" rows="2"
                            placeholder="Példák: 52, 48.5, 30 vagy 45 60 55... (1.1.6.1 a mérőórán a kódja)"
                            class="styled-input"></textarea>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                            <button class="btn btn-primary btn-sm" onclick="parseBulkData()"
                                style="flex: 4; padding: 0.5rem; font-size: 0.8rem; font-weight: 700;">
                                <i class="fas fa-paste me-2"></i> Beillesztés
                            </button>
                            <button class="btn btn-sm" onclick="clearData()"
                                style="flex: 1; padding: 0.5rem; background: #dc2626; color: white !important; border: none; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 #991b1b !important;">
                                <i class="fas fa-trash-alt" style="color: white !important;"></i>
                            </button>
                        </div>
                        <div id="calc-hint" class="mt-2 text-center"
                            style="display: none; font-size: 0.75rem; color: var(--primary); font-weight: 700; font-style: italic; animation: pulse 2s infinite;">
                            <i class="fas fa-arrow-down me-1"></i> Kattints az optimalizálás futtatására!
                        </div>
                    </div>

                    <div id="calc-step" style="display:none;">
                        <button class="btn-calc" onclick="calculateOptimum()">
                            <i class="fas fa-calculator me-2"></i> OPTMALIZÁLÁS FUTTATÁSA
                        </button>
                    </div>

                    <div class="mt-4 small text-muted">
                        <p><i class="fas fa-info-circle me-1"></i> A program automatikusan a legkedvezőbb hónapokat
                            jelöli bejelenthetőnek (3 vagy 6). A bejelentés elmulasztása (ideiglenes lekötött
                            teljesítmény túllépés bejelentésének elmulasztása) jelentős pótdíjjal jár.</p>
                    </div>
                </div>

                <div class="pro-card" style="overflow-y: auto; max-height: 500px;">
                    <h5 class="mb-3" style="font-weight: 800;">Bemeneti Adatok (kW)</h5>
                    <div class="month-grid" id="month-inputs">
                        <!-- JS renders -->
                    </div>
                </div>
            </div>

            <div id="results-area" style="display: none;">
                <div class="result-summary-grid">
                    <div class="summary-box">
                        <span>ÁTLAG</span>
                        <strong id="avg-val">-- kW</strong>
                    </div>
                    <div class="summary-box" style="border-color: var(--success-pro); border-width: 2px;">
                        <span>OPTIMÁLIS LEKÖTÉS</span>
                        <strong id="rec-val" style="color: var(--success-pro);">-- kW</strong>
                    </div>
                    <div class="summary-box" style="border-color: var(--warning-pro);">
                        <span>MAX. CSÚCS</span>
                        <strong id="max-peak-val" style="color: var(--warning-pro);">-- kW</strong>
                    </div>
                    <div class="summary-box">
                        <span>LIMIT</span>
                        <strong id="limit-val">-- hó</strong>
                    </div>
                    <div class="summary-box"
                        style="border-color: var(--danger-pro); background: rgba(239, 68, 68, 0.05);">
                        <span>ÉVES KOCKÁZAT</span>
                        <strong id="risk-val" style="color: var(--danger-pro);">-- Ft</strong>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-5">
                        <div class="pro-card">
                            <h5 class="mb-4" style="font-weight: 800;">Összesített Mérleg</h5>
                            <div class="cost-row">
                                <span class="label">Éves Alapdíj (<span id="base-calc-label">--</span>)</span>
                                <span class="value" id="base-cost-val">-- Ft</span>
                            </div>
                            <div class="cost-row">
                                <span class="label">Éves Bejelentett Pótdíj</span>
                                <span class="value" id="ann-penalty-val">-- Ft/év</span>
                            </div>
                            <div class="cost-row">
                                <span class="label">Éves Bejelentés nélküli Pótdíj</span>
                                <span class="value" id="unann-penalty-val">-- Ft/év</span>
                            </div>
                            <div class="mt-4 pt-3" style="border-top: 2px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                    <div>
                                        <span
                                            style="font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted);">Optimalizált
                                            Éves Díj:</span>
                                        <div style="font-size: 0.65rem; color: var(--text-muted); line-height: 1;"
                                            id="best-total-hint">Alapdíj + Évesített pótdíjak</div>
                                    </div>
                                    <span id="grand-total-val"
                                        style="font-size: 2rem; font-weight: 900; color: var(--accent-pro); line-height: 1;">--
                                        Ft/év</span>
                                </div>
                            </div>
                            <div id="risk-info" class="mt-3 p-3 rounded"
                                style="background: rgba(239, 68, 68, 0.1); font-size: 0.8rem; display: none;">
                                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                <strong>Figyelem!</strong> Magyarországon az ideiglenes lekötött teljesítmény túllépés
                                bejelentésének elmulasztása esetén az éves költség
                                <span id="worst-total-val" style="font-weight: 800;">-- Ft/év</span>-re emelkedik.
                            </div>

                            <div id="savings-box" class="savings-box">
                                <div class="save-title">Becsült éves megtakarítás</div>
                                <div class="save-value" id="savings-val">-- Ft</div>
                                <div class="save-percent" id="savings-percent-val">--%</div>
                                <div class="mt-2 small" style="opacity: 0.8; font-size: 0.7rem;">
                                    A jelenlegi <span id="current-cap-ref">--</span> kW-os lekötéshez képest
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="pro-card" style="height: 100%;">
                            <canvas id="opt-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../../js/main.js"></script>
    <script>
        const inputsDiv = document.getElementById('month-inputs');
        let chartInstance = null;

        for (let i = 0; i < 24; i++) {
            const div = document.createElement('div');
            div.id = `m-cont-${i}`;
            div.className = "p-1 rounded";
            div.style.position = "relative";
            div.innerHTML = `<label class="field-label" style="font-size:0.6rem; margin-bottom:2px;">${i + 1}. HÓ</label>
                             <input type="text" class="month-input" data-index="${i}" value="0" oninput="liveValidate(this)">`;
            inputsDiv.appendChild(div);
        }

        // Demo parabolic data
        const demoPeaks = [
            32, 35, 38, 42, 45, 48, 52, 55, 58, 62, 65, 68,
            68, 65, 62, 58, 55, 52, 48, 45, 42, 38, 35, 32
        ];

        function loadDemoData() {
            const inputs = document.querySelectorAll('.month-input');
            demoPeaks.forEach((v, i) => {
                if (i < inputs.length) inputs[i].value = v;
            });
            document.getElementById('calc-step').style.display = 'block';
            document.getElementById('calc-hint').style.display = 'block';
        }

        function clearData() {
            document.querySelectorAll('.month-input').forEach(inp => {
                inp.value = "0";
                inp.classList.remove('invalid');
            });
            document.getElementById('error-banner').style.display = 'none';
            document.getElementById('no-data-banner').style.display = 'none';
            document.getElementById('results-area').style.display = 'none';
            document.getElementById('calc-hint').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDemoData();
            updatePenaltyInfo();
            // Auto run once to show initial state
            setTimeout(() => calculateOptimum(false), 100);
        });

        function liveValidate(input) {
            const valStr = input.value.trim();
            const val = parseFloat(valStr);
            const isOk = valStr === "" || (!isNaN(val) && val <= 100 && /^\d*\.?\d*$/.test(valStr));

            if (!isOk) {
                input.classList.add('invalid');
                document.getElementById('error-banner').style.display = 'block';
            } else {
                input.classList.remove('invalid');
                if (document.querySelectorAll('.month-input.invalid').length === 0) {
                    document.getElementById('error-banner').style.display = 'none';
                }
            }
        }

        function updatePenaltyInfo() {
            const sel = document.getElementById('tariff-select');
            let rate = (sel.value === 'custom') ? parseFloat(document.getElementById('annual-fee').value) : parseFloat(sel.value);
            if (isNaN(rate)) rate = 0;

            const annMoney = Math.round(rate * 0.10);
            const unannMoney = Math.round(rate * 0.25);

            document.getElementById('ann-money-display').innerText = annMoney.toLocaleString('hu-HU') + " Ft";
            document.getElementById('unann-money-display').innerText = unannMoney.toLocaleString('hu-HU') + " Ft";
        }

        function updateTariffValue() {
            const sel = document.getElementById('tariff-select');
            const block = document.getElementById('custom-fee-block');
            const inp = document.getElementById('annual-fee');
            if (sel.value === 'custom') {
                block.style.display = 'block';
            } else {
                block.style.display = 'none';
                inp.value = sel.value;
            }
            updatePenaltyInfo();
        }

        function parseBulkData() {
            const val = document.getElementById('bulk-input').value;
            const nums = val.split(/[,\s\n\t]+/).filter(s => s.trim() !== "");
            const inputs = document.querySelectorAll('.month-input');
            nums.forEach((n, i) => {
                if (i < inputs.length) {
                    inputs[i].value = n;
                    liveValidate(inputs[i]);
                }
            });
            document.getElementById('calc-step').style.display = 'block';
            document.getElementById('calc-hint').style.display = 'block';
            document.getElementById('results-area').style.display = 'none';
        }

        function calculateOptimum(scroll = true) {
            document.getElementById('calc-hint').style.display = 'none';
            const sel = document.getElementById('tariff-select');
            let annualRate = (sel.value === 'custom') ? parseFloat(document.getElementById('annual-fee').value) : parseFloat(sel.value);

            const inputs = document.querySelectorAll('.month-input');
            let peaks = [];
            let err = false;

            inputs.forEach(inp => {
                const s = inp.value.trim();
                const v = parseFloat(s);
                if (s !== "" && (isNaN(v) || v > 100 || !/^\d*\.?\d*$/.test(s))) err = true;
                peaks.push(isNaN(v) ? 0 : v);
            });

            if (err) {
                alert("Saját téves érték! Kérjük javítsa a hibás (piros) mezőket (Max 100 kW).");
                return;
            }

            if (peaks.every(p => p === 0)) {
                document.getElementById('no-data-banner').style.display = 'block';
                document.getElementById('results-area').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            document.getElementById('no-data-banner').style.display = 'none';

            document.getElementById('results-area').style.display = 'block';

            const usedPeaks = peaks.filter(p => p > 0);
            const maxPeak = Math.max(...peaks);
            const avgVal = usedPeaks.length > 0 ? (usedPeaks.reduce((a, b) => a + b, 0) / usedPeaks.length) : 0;

            // Determine years and announcement limit
            // Rule: 6 announcements only if all 24 months are filled. Otherwise max 3.
            const years = usedPeaks.length > 12 ? 2 : 1;
            const annLimit = usedPeaks.length === 24 ? 6 : 3;

            if (usedPeaks.length < 5) {
                alert("Az optimalizáláshoz legalább 5 hónap adata szükséges a pontos eredményhez! (Jelenleg: " + usedPeaks.length + " hó)");
                return;
            }

            document.getElementById('avg-val').innerText = avgVal.toFixed(1) + " kW";
            document.getElementById('max-peak-val').innerText = maxPeak.toFixed(1) + " kW";
            document.getElementById('limit-val').innerText = annLimit + " hó / " + years + " év";

            // TESTING RANGE: 1 to 100 kW as requested for smooth curve
            let candidates = [];
            for (let i = 1; i <= 100; i++) candidates.push(i);

            let minSum = Infinity, bestCap = 0, bestBase = 0, bestAnnP = 0, bestUnannP = 0, bestWorstTotal = 0;
            const chartData = [];

            candidates.forEach(cap => {
                let base = cap * annualRate;
                let annP = 0, unannP = 0, worstP = 0;

                let monthDetails = peaks.map((p, i) => {
                    let exc = Math.max(0, p - cap);
                    worstP += exc * annualRate * 0.25;
                    return { idx: i, val: p, exc: exc };
                });

                let sortedExc = monthDetails.filter(m => m.exc > 0).sort((a, b) => b.exc - a.exc);
                let annIdxs = sortedExc.slice(0, annLimit).map(m => m.idx);

                monthDetails.forEach(m => {
                    if (m.exc > 0) {
                        if (annIdxs.includes(m.idx)) {
                            annP += m.exc * annualRate * 0.10;
                        } else {
                            unannP += m.exc * annualRate * 0.25;
                        }
                    }
                });

                let total = base + (annP + unannP) / years;
                if (total < minSum) {
                    minSum = total;
                    bestCap = cap;
                    bestBase = base;
                    bestAnnP = annP / years;
                    bestUnannP = unannP / years;
                    bestWorstTotal = base + worstP / years;
                }
                chartData.push({ x: cap, y: total });
            });

            // Calculate current contract cost for comparison
            const currentCap = parseFloat(document.getElementById('current-contract-cap').value) || 0;
            let currentTotal = 0;
            if (currentCap > 0) {
                let base = currentCap * annualRate;
                let annP = 0, unannP = 0;
                let monthDetails = peaks.map((p, i) => {
                    let exc = Math.max(0, p - currentCap);
                    return { idx: i, val: p, exc: exc };
                });
                let sortedExc = monthDetails.filter(m => m.exc > 0).sort((a, b) => b.exc - a.exc);
                let annIdxs = sortedExc.slice(0, annLimit).map(m => m.idx);
                monthDetails.forEach(m => {
                    if (m.exc > 0) {
                        if (annIdxs.includes(m.idx)) annP += m.exc * annualRate * 0.10;
                        else unannP += m.exc * annualRate * 0.25;
                    }
                });
                currentTotal = base + annP + unannP;
            }

            document.getElementById('rec-val').innerText = bestCap + " kW";
            document.getElementById('base-calc-label').innerText = bestCap + " kW × " + Math.round(annualRate).toLocaleString('hu-HU') + " Ft";
            document.getElementById('base-cost-val').innerText = Math.round(bestBase).toLocaleString('hu-HU') + " Ft";
            document.getElementById('ann-penalty-val').innerText = Math.round(bestAnnP).toLocaleString('hu-HU') + " Ft/év";
            document.getElementById('unann-penalty-val').innerText = Math.round(bestUnannP).toLocaleString('hu-HU') + " Ft/év";
            document.getElementById('grand-total-val').innerText = Math.round(minSum).toLocaleString('hu-HU') + " Ft/év";

            const risk = bestWorstTotal - minSum;
            document.getElementById('risk-val').innerText = "+" + Math.round(risk).toLocaleString('hu-HU') + " Ft/év";
            document.getElementById('worst-total-val').innerText = Math.round(bestWorstTotal).toLocaleString('hu-HU') + " Ft/év";
            document.getElementById('risk-info').style.display = (risk > 100) ? 'block' : 'none';

            // Savings calculation
            if (currentTotal > minSum) {
                const diff = currentTotal - minSum;
                const pct = (diff / currentTotal) * 100;
                document.getElementById('savings-box').style.display = 'block';
                document.getElementById('savings-val').innerText = Math.round(diff).toLocaleString('hu-HU') + " Ft";
                document.getElementById('savings-percent-val').innerText = pct.toFixed(1) + "% megtakarítás";
                document.getElementById('current-cap-ref').innerText = currentTotal > 0 ? parseFloat(document.getElementById('current-contract-cap').value) : "--";
            } else {
                document.getElementById('savings-box').style.display = 'none';
            }

            const finalDetails = peaks.map(p => ({ val: p, exc: Math.max(0, p - bestCap) }));
            const finalSort = finalDetails.map((d, i) => ({ ...d, idx: i })).filter(d => d.exc > 0).sort((a, b) => b.exc - a.exc);
            const bestAnnIdxs = finalSort.slice(0, annLimit).map(d => d.idx);

            inputsDiv.querySelectorAll('.p-1').forEach((cont, i) => {
                cont.className = "p-1 rounded";
                if (peaks[i] === maxPeak && maxPeak > 0) cont.classList.add('max-highlight');
                if (bestAnnIdxs.includes(i)) cont.classList.add('announced-highlight');
            });

            renderChart(chartData, bestCap);
            if (scroll) {
                window.scrollTo({ top: document.getElementById('results-area').offsetTop - 100, behavior: 'smooth' });
            }
        }

        function renderChart(data, best) {
            const ctx = document.getElementById('opt-chart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            // Custom point styling to highlight the best capacity in red
            const pointColors = data.map(d => (d.x === best) ? '#ef4444' : '#4361ee');
            const pointRadii = data.map(d => (d.x === best) ? 8 : 2);
            const pointOrders = data.map(d => (d.x === best) ? 2 : 1);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.x),
                    datasets: [{
                        label: 'Éves Díj (Ft)',
                        data: data.map(d => d.y),
                        borderColor: '#4361ee',
                        borderWidth: 2,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: pointRadii,
                        pointHoverRadius: 10,
                        fill: false,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (c) => ` ${c.parsed.x} kW: ${Math.round(c.parsed.y).toLocaleString()} Ft/év`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => v.toLocaleString() + ' Ft' },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            title: { display: true, text: 'Lekötött Teljesítmény (kW)', font: { weight: 'bold' } },
                            grid: { display: false },
                            min: 1,
                            max: 100
                        }
                    }
                }
            });
        }
        async function exportPowerReport() {
            // Confirm we have data
            if (document.getElementById('results-area').style.display === 'none') {
                App.notify('Kérjük futtassa az optimalizálást előbb!', 'warning');
                return;
            }

            App.notify('Generálás...', 'info');

            // 0. Scroll to top to ensure capture starts correctly
            window.scrollTo(0, 0);

            // 0.5 Set Print Date
            const now = new Date();
            const dateStr = now.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('print-date-display').innerText = dateStr;

            // 1. Enter Print Mode
            document.body.classList.add('printing-mode');

            // Wait for styles/repaint
            setTimeout(() => {
                const element = document.querySelector('main');

                const opt = {
                    margin: [10, 10],
                    filename: App.getExportFileName('Teljesitmeny_Optimalizalo', 'pdf'),
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        windowWidth: document.body.scrollWidth,
                        windowHeight: document.body.scrollHeight
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().from(element).set(opt).save()
                    .then(() => {
                        document.body.classList.remove('printing-mode');
                        App.notify('Sikeres letöltés!', 'success');
                    })
                    .catch(err => {
                        console.error(err);
                        document.body.classList.remove('printing-mode');
                        App.notify('Hiba történt.', 'error');
                    });
            }, 500);
        }
        updateTariffValue();
    </script>
</body>

</html>