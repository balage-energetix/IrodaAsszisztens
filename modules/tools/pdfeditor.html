<!DOCTYPE html>
<html lang="hu" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF szerkesztő - Irodai Asszisztens</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/main.css">
    <style>
        .edit-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .edit-card {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .file-list {
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            min-height: 100px;
            padding: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-action {
            width: 100%;
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 1rem;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-action:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }
    </style>
</head>

<body>
    <header class="app-header">
        <a href="../../index.html" class="logo"><i class="fas fa-bolt" style="color:var(--accent);"></i><span>Irodai
                Asszisztens</span></a>
        <div class="header-info">
            <div id="header-weather"></div>
            <div id="global-clock"></div><button onclick="App.toggleTheme()"
                style="background:none; border:none; font-size:1.4rem; color:var(--text-main); cursor:pointer;"><i
                    id="theme-toggle-icon" class="fas fa-moon"></i></button>
        </div>
    </header>

    <main class="container py-5 fade-in">
        <h2 class="mb-5" style="font-family:'Outfit'; font-weight:800;"><i
                class="fas fa-file-signature text-primary me-2"></i>PDF szerkesztő</h2>

        <div class="edit-layout">
            <!-- ÖSSZEILLESZTÉS -->
            <div class="edit-card">
                <h4 style="font-family:'Outfit'; font-weight:800; color:var(--primary); margin-bottom:1.5rem;"><i
                        class="fas fa-layer-group me-2"></i>PDF Összeillesztés</h4>
                <p style="font-size: 0.85rem; color: var(--text-muted);">Válasszon ki több PDF fájlt az egyesítéshez.
                </p>
                <input type="file" id="merge-input" multiple accept="application/pdf" style="display:none;"
                    onchange="updateList('merge')">
                <button class="feature-card" style="width:100%; border-style:dashed; margin-top:1rem;"
                    onclick="document.getElementById('merge-input').click()">+ Fájlok hozzáadása</button>
                <div class="file-list" id="merge-list"></div>
                <button class="btn-action" onclick="mergePDFs()">EGYESÍTÉS ÉS LETÖLTÉS</button>
            </div>

            <!-- DARABOLÁS -->
            <div class="edit-card">
                <h4 style="font-family:'Outfit'; font-weight:800; color:var(--accent); margin-bottom:1.5rem;"><i
                        class="fas fa-scissors me-2"></i>PDF Darabolás</h4>
                <p style="font-size: 0.85rem; color: var(--text-muted);">Válasszon egy PDF-et és adja meg az
                    oldalszámokat.</p>
                <input type="file" id="split-input" accept="application/pdf" style="display:none;"
                    onchange="updateList('split')">
                <button class="feature-card" style="width:100%; border-style:dashed; margin-top:1rem;"
                    onclick="document.getElementById('split-input').click()">Fájl kiválasztása</button>
                <div class="file-list" id="split-list"></div>
                <div style="margin-top: 1.5rem;">
                    <label
                        style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 0.5rem;">Tartomány
                        kijelölése (pl: 1-3, 5, 8-10)</label>
                    <input type="text" id="split-range" class="styled-input"
                        style="width: 100%; padding: 1.25rem; border-radius: 1rem; border: 2px solid var(--border-color); font-size: 1.1rem; font-family: var(--font-main); outline: none; transition: 0.2s;"
                        placeholder="Adja meg az oldalakat...">
                </div>
                <button class="btn-action" style="background:var(--accent); margin-top: 1rem;"
                    onclick="splitPDF()">OLDALAK KINYERÉSE</button>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        let mergeFiles = [];
        let splitFile = null;

        function updateList(type) {
            if (type === 'merge') {
                const input = document.getElementById('merge-input');
                mergeFiles = Array.from(input.files);
                const list = document.getElementById('merge-list');
                list.innerHTML = mergeFiles.map(f => `<div class="file-item"><span>${f.name}</span> <i class="fas fa-file-pdf"></i></div>`).join('');
            } else {
                splitFile = document.getElementById('split-input').files[0];
                document.getElementById('split-list').innerHTML = `<div class="file-item"><span>${splitFile.name}</span> <i class="fas fa-file-pdf"></i></div>`;
            }
        }

        async function mergePDFs() {
            if (mergeFiles.length < 2) return alert("Hiba: Legalább 2 fájl szükséges.");
            const mergedPdf = await PDFLib.PDFDocument.create();
            for (const f of mergeFiles) {
                const pdf = await PDFLib.PDFDocument.load(await f.arrayBuffer());
                const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                copiedPages.forEach((page) => mergedPdf.addPage(page));
            }
            const pdfBytes = await mergedPdf.save();
            download(pdfBytes, 'Osszeillesztett.pdf');
        }

        async function splitPDF() {
            if (!splitFile) return alert("Válasszon fájlt!");
            const rangeStr = document.getElementById('split-range').value;
            if (!rangeStr) return alert("Adjon meg oldaltartományt!");

            try {
                const existingPdf = await PDFLib.PDFDocument.load(await splitFile.arrayBuffer());
                const pageCount = existingPdf.getPageCount();
                const pagesToExtract = [];

                // Advanced Range Logic: handles "1, 3-5, 8"
                const parts = rangeStr.split(',');
                parts.forEach(part => {
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(p => parseInt(p.trim()));
                        if (!isNaN(start) && !isNaN(end)) {
                            for (let i = start; i <= end; i++) {
                                if (i > 0 && i <= pageCount) pagesToExtract.push(i - 1);
                            }
                        }
                    } else {
                        const page = parseInt(part.trim());
                        if (!isNaN(page) && page > 0 && page <= pageCount) {
                            pagesToExtract.push(page - 1);
                        }
                    }
                });

                if (pagesToExtract.length === 0) return alert("Hiba: Érvénytelen oldalszámok vagy tartomány.");

                // Deduplicate and sort
                const uniquePages = [...new Set(pagesToExtract)].sort((a, b) => a - b);

                const newPdf = await PDFLib.PDFDocument.create();
                const copiedPages = await newPdf.copyPages(existingPdf, uniquePages);
                copiedPages.forEach(p => newPdf.addPage(p));

                const pdfBytes = await newPdf.save();
                download(pdfBytes, 'Darabolt.pdf');
            } catch (err) {
                console.error(err);
                alert("Hiba történt a PDF feldolgozása közben.");
            }
        }

        function download(bytes, name) {
            const blob = new Blob([bytes], { type: "application/pdf" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = App.getExportFileName(name.split('.')[0], 'pdf');
            link.click();
        }
    </script>
</body>

</html>