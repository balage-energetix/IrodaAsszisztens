<!DOCTYPE html>
<html lang="hu" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mérőállás Rögzítő - Irodai Asszisztens</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/main.css">
    <style>
        .meter-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .search-area {
            position: relative;
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 1.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .search-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-item:hover {
            background: rgba(var(--primary-rgb), 0.05);
        }

        .search-item strong {
            display: block;
            color: var(--primary);
        }

        .search-item small {
            color: var(--text-muted);
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .list-table th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 800;
        }

        .list-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .reading-input {
            width: 120px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            text-align: right;
            font-weight: 700;
        }

        .delete-btn {
            color: #f44336;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .delete-btn:hover {
            transform: scale(1.2);
        }

        @media print {

            .app-header,
            .search-area,
            .back-btn,
            .delete-btn,
            .sub-nav-bar {
                display: none !important;
            }

            .meter-container {
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
            }

            body {
                background: white !important;
                color: black !important;
            }

            .list-table th {
                background: #eee !important;
                color: black !important;
            }
        }
    </style>
</head>

<body>
    <header class="app-header">
        <a href="../../index.html" class="logo"><i class="fab fa-android"></i><span>IRODAI<br>ASSZISZTENS</span></a>
        <div class="header-info">
            <div id="header-weather"></div>
            <div id="global-clock"></div>
        </div>
    </header>

    <main class="meter-container fade-in">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title mb-0"><i class="fas fa-gauge-high text-primary me-2"></i>Mérőállás Rögzítő</h2>
            <button class="btn-premium" onclick="window.print()">
                <i class="fas fa-file-pdf"></i> PDF Mentés / Nyomtatás
            </button>
        </div>

        <div class="search-area">
            <p class="text-muted mb-3">Keressen fogyasztási helyre név, cím vagy POD azonosító alapján:</p>
            <div class="search-box">
                <input type="text" id="meterSearch" placeholder="Kezdjen el gépelni..." autocomplete="off">
                <i class="fas fa-search"></i>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="table-responsive">
            <table class="list-table" id="readingTable">
                <thead>
                    <tr>
                        <th>Fogyasztási Hely / Cím</th>
                        <th>Azonosító (POD / Óra)</th>
                        <th>Aktuális Állás</th>
                        <th>Dátum</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody id="readingList">
                    <!-- Rows added dynamically -->
                </tbody>
            </table>
        </div>

        <div id="empty-hint" class="text-center p-5 text-muted">
            <i class="fas fa-clipboard-list fa-3x mb-3"></i>
            <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                <h3 class="group-title mb-0"><i class="fas fa-gauge-high me-2"></i> Mérőállás Rögzítő</h3>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="window.print()">
                        <i class="fas fa-print me-1"></i> Nyomtatás / PDF
                    </button>
                    <button class="btn btn-danger" onclick="clearAll()">
                        <i class="fas fa-trash-alt me-1"></i> Összes törlése
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <div class="search-container no-print">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchInput" class="search-input"
                                    placeholder="Keressen címre, mérőhely nevére vagy POD azonosítóra...">
                                <div id="resultsBox" class="search-results"></div>
                            </div>

                            <div class="table-responsive">
                                <table class="table registry-table" id="readingTable">
                                    <thead>
                                        <tr>
                                            <th>Mérőhely / Cím</th>
                                            <th>POD Azonosító</th>
                                            <th>Óraállás</th>
                                            <th>Fotó</th>
                                            <th>Dátum</th>
                                            <th class="text-center no-print">Művelet</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listBody">
                                        <!-- Dinamikus tartalom -->
                                    </tbody>
                                </table>
                                <div id="emptyState" class="text-center py-5 text-muted">
                                    <i class="fas fa-clipboard-list fa-3x mb-3 opacity-50"></i>
                                    <p>Nincs rögzített mérőállás. Keressen fent a hozzáadáshoz!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </main>

    <div id="photo-modal">
        <h5>Mérőóra Fotózása</h5>
        <div id="camera-mock"
            style="background:#eee; height:200px; display:flex; align-items:center; justify-content:center; margin-bottom:15px; border-radius:8px;">
            <i class="fas fa-camera fa-3x opacity-20"></i>
        </div>
        <p class="small text-muted">Helyszíni dokumentáció rögzítése...</p>
        <button class="btn btn-primary btn-sm" onclick="closePhoto()">Kép rögzítése</button>
    </div>
    <div class="modal-overlay" id="modal-overlay" onclick="closePhoto()"></div>

    <script src="../../js/main.js"></script>
    <script src="../../js/registry_data.js"></script>
    <script>
        const searchInput = document.getElementById('searchInput');
        const resultsBox = document.getElementById('resultsBox');
        const listBody = document.getElementById('listBody');
        const emptyState = document.getElementById('emptyState');
        // Extract usable locations from REGISTRY_DATA
        let locations = [];
        if (window.REGISTRY_DATA) {
            window.REGISTRY_DATA.forEach(file => {
                if (file.tables) {
                    file.tables.forEach(table => {
                        // Look for typical headers like "Cím", "Név", "POD"
                        let nameIdx = -1, addrIdx = -1, podIdx = -1;
                        table.headers.forEach((h, i) => {
                            const low = h.toLowerCase();
                            if (low.includes('cím')) addrIdx = i;
                            if (low.includes('név') || low.includes('elnevezés')) nameIdx = i;
                            if (low.includes('pod') || low.includes('azonosító') || low.includes('óra')) podIdx = i;
                        });

                        if (addrIdx !== -1 || nameIdx !== -1) {
                            table.rows.forEach(row => {
                                const name = nameIdx !== -1 ? (typeof row[nameIdx] === 'object' ? row[nameIdx].text : row[nameIdx]) : '';
                                const addr = addrIdx !== -1 ? (typeof row[addrIdx] === 'object' ? row[addrIdx].text : row[addrIdx]) : '';
                                const info = podIdx !== -1 ? (typeof row[podIdx] === 'object' ? row[podIdx].text : row[podIdx]) : '';

                                if (name || addr) {
                                    locations.push({
                                        name: name || 'Névtelen helyszín',
                                        address: addr || 'Nincs cím megadva',
                                        pod: info || 'Nincs ID'
                                    });
                                }
                            });
                        }
                    });
                }
            });
        }

        // Betöltés local storage-ból
        window.onload = () => {
            const saved = localStorage.getItem('meter_readings');
            if (saved) {
                const data = JSON.parse(saved);
                data.forEach(item => renderRow(item.name, item.addr, item.pod, item.val, item.date));
                checkEmpty();
            }
        };

        function saveToLocal() {
            const rows = [];
            document.querySelectorAll('#listBody tr').forEach(tr => {
                rows.push({
                    name: tr.querySelector('strong').innerText,
                    addr: tr.querySelector('small').innerText,
                    pod: tr.querySelector('code').innerText,
                    val: tr.querySelector('.reading-input').value,
                    date: tr.cells[4].innerText
                });
            });
            localStorage.setItem('meter_readings', JSON.stringify(rows));
        }

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            if (val.length < 2) {
                resultsBox.style.display = 'none';
                return;
            }

            // Kiterjesztett keresés: több szóra is keresünk
            const terms = val.split(' ');
            const filtered = locations.filter(l => {
                const text = `${l.name} ${l.address} ${l.pod}`.toLowerCase();
                return terms.every(term => text.includes(term));
            }).slice(0, 15);

            if (filtered.length > 0) {
                resultsBox.innerHTML = filtered.map(l => `
                    <div class="search-item" onclick="addLocation('${l.name.replace(/'/g, "\\'")}', '${l.address.replace(/'/g, "\\'")}', '${l.pod}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${l.name}</strong><br>
                                <small>${l.address}</small>
                            </div>
                            <code class="ms-2">${l.pod}</code>
                        </div>
                    </div>
                `).join('');
                resultsBox.style.display = 'block';
            } else {
                resultsBox.style.display = 'none';
            }
        });

        function addLocation(name, addr, pod) {
            const date = new Date().toLocaleDateString('hu-HU');
            renderRow(name, addr, pod, '', date);
            resultsBox.style.display = 'none';
            searchInput.value = '';
            checkEmpty();
            saveToLocal();
        }

        function renderRow(name, addr, pod, val, date) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <strong>${name}</strong><br>
                    <small class="text-muted">${addr}</small>
                </td>
                <td><code style="font-size:0.8rem;">${pod}</code></td>
                <td><input type="number" class="reading-input" value="${val}" placeholder="0" oninput="saveToLocal()"></td>
                <td>
                    <i class="fas fa-camera photo-btn" onclick="openPhoto()"></i>
                    <span class="badge bg-success d-none" id="photo-badge-${pod}">OK</span>
                </td>
                <td style="font-weight:700;">${date}</td>
                <td class="text-center no-print">
                    <i class="fas fa-trash-alt delete-btn" onclick="this.closest('tr').remove(); checkEmpty(); saveToLocal();"></i>
                </td>
            `;
            listBody.appendChild(tr);
        }

        function checkEmpty() {
            if (listBody.children.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('readingTable').style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                document.getElementById('readingTable').style.display = 'table';
            }
        }

        function clearAll() {
            if (confirm('Biztosan törli az összes rögzített adatot?')) {
                listBody.innerHTML = '';
                checkEmpty();
                localStorage.removeItem('meter_readings');
            }
        }

        function openPhoto() {
            document.getElementById('photo-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        }

        function closePhoto() {
            document.getElementById('photo-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // Kattintás a keresőn kívül
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                resultsBox.style.display = 'none';
            }
        });
    </script>
</body>

</html>